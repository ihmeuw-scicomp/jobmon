services:
  jobmon_backend:
    build: 
      context: ./
      dockerfile: ./jobmon_server/Dockerfile.local
      args:
        EDITABLE: "${EDITABLE:-true}"  # Default to true for local dev
        EXTRAS: "${EXTRAS:-mysql,otlp}" # Include otlp for template system compatibility
    ports:
      - "8070:80"
    volumes:
      - ./jobmon_core:/app/jobmon_core:ro
      - ./jobmon_server:/app/jobmon_server  # Remove :ro to allow database creation
      - ./dev/config:/app/config:ro  # Mount local config directory
    environment:
      # Jobmon Configuration
      - JOBMON__CONFIG_FILE=/app/config/jobmonconfig.local.yaml
    env_file:
      - .env
    command: >
      /bin/sh -c "python -m uvicorn --factory main:get_app --host 0.0.0.0 --port 80 --workers 6"

  jobmon_frontend:
    build: 
      context: ./jobmon_gui
      dockerfile: ./Dockerfile.local
    ports:
      - "3000:3000"
    volumes:
      - ./jobmon_gui/src:/app/src
    environment:
      - REACT_APP_API_URL=http://localhost:8070/api/v3

  jobmon_client:
    build:
      context: ./
      dockerfile: ./jobmon_client/Dockerfile.local
      args:
        EDITABLE: "${EDITABLE:-true}"  # Default to true for local dev
        EXTRAS: "${CLIENT_EXTRAS:-otlp}"  # Default extras for client
    volumes:
      - ./jobmon_core:/app/jobmon_core:ro
      - ./jobmon_client:/app/jobmon_client:ro
      - ./dev/config:/app/config:ro  # Mount local config directory
      - ./dev/workflows:/app/test_scripts  # Volume for test workflow scripts
    environment:
      # Jobmon Configuration
      - JOBMON__CONFIG_FILE=/app/config/jobmonconfig.local.yaml
    env_file:
      - .env
    stdin_open: true  # Keep STDIN open for interactive use
    tty: true         # Allocate a pseudo-TTY for interactive use
