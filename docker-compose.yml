services:
  jobmon_backend:
    build: 
      context: ./
      dockerfile: ./jobmon_server/Dockerfile.local
      args:
        EDITABLE: "${EDITABLE:-true}"  # Default to true for local dev
        EXTRAS: "${EXTRAS:-mysql,otlp}" # Include otlp for template system compatibility
    ports:
      - "8070:80"
    volumes:
      - ./jobmon_core:/app/jobmon_core:ro
      - ./jobmon_server:/app/jobmon_server:ro
      - ./config:/app/config:ro  # Mount local config directory
    environment:
      # Jobmon Configuration
      - JOBMON_CONFIG_FILE=/app/config/jobmonconfig.local.yaml
      - JOBMON__AUTH__ENABLED=false
      # OTLP Debugging
      - OTEL_PYTHON_LOG_CORRELATION=true
      - OTEL_PYTHON_LOG_LEVEL=DEBUG
      - OTEL_LOG_LEVEL=DEBUG
      - OTEL_LOGS_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
      - OTEL_TRACES_EXPORTER=otlp
      # Logging debugging
      - LOG_LEVEL=DEBUG
      - PYTHONPATH=/app
    env_file:
      - .env
    command: >
      /bin/sh -c "fastapi run /app/main.py --port 80 --reload"

  jobmon_frontend:
    build: 
      context: ./jobmon_gui
      dockerfile: ./Dockerfile.local
    ports:
      - "3000:3000"
    volumes:
      - ./jobmon_gui/src:/app/src:ro
    environment:
      - REACT_APP_API_URL=http://localhost:8070/api/v3

